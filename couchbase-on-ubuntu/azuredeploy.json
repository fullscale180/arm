{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adminUsername": {
            "type": "string",
            "metadata": {
                "Description": "Admin username used when provisioning virtual machines"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "Description": "Admin password used when provisioning virtual machines"
            }
        },
        "storageAccountName": {
            "type": "string",
            "defaultValue": "cbdeploy",
            "metadata": {
                "Description": "Storage account name"
            }
        },
        "targetRegion": {
            "type": "string",
            "defaultValue": "West US",
            "metadata": {
                "Description": "Location where resources will be provisioned"
            }
        },
        "virtualNetworkName": {
            "type": "string",
            "defaultValue": "couchVnet",
            "metadata": {
                "Description": "Virtual Network"
            }
        },
        "cbClusterName": {
            "type": "string",
            "defaultValue": "couchbasecluster",
            "metadata": {
                "Description": "The name of the Couchbase cluster"
            }
        },
        "tshirtSize": {
            "type": "string",
            "defaultValue": "S",
            "allowedValues": [
                "S",
                "M",
                "L"
            ],
            "metadata": {
                "Description": "T-shirt size of the Couchbase cluster"
            }
        },
        "dnsNameforLBIP": {
            "type": "string",
            "defaultValue": "fs180cbsample",
            "metadata": {
                "Description": "Load balancer subdomain name: for example (<subdomain>.westus.cloudapp.azure.com)"
            }
        },
        "vmNamePrefix": {
            "type": "string",
            "defaultValue": "cbnode",
            "metadata": {
                "Description": "Prefx for VM names on the cluster"
            }
        },
        "cbVersion": {
            "type": "string",
            "defaultValue": "3.0.3",
            "allowedValues": ["3.0.3"],
            "metadata": {
                "Description": "Couchbase version to install"
            }
        },
        "jumpbox": {
            "type": "string",
            "defaultValue": "enabled",
            "allowedValues": [
                "enabled",
                "disabled"
            ],
            "metadata": {
                "Description": "The flag allowing to enable or disable provisioning of the jumpbox VM that can be used to access the nodes"
            }
        },
        "gituser": {
            "type": "string",
            "defaultValue": "fullscale180",
            "metadata": {
                "Description": "Github user to bring the scripts for"
            }
        },
        "gitrepo": {
            "type": "string",
            "defaultValue": "arm",
            "metadata": {
                "Description": "Github repo the templates and scripts are on."
            }
        },
        "gitrepodir": {
            "type": "string",
            "defaultValue": "couchbase-on-ubuntu",
            "metadata": {
                "Description": "Directory where the scripts reside under the repo."
            }
        }
    },
    "variables": {
        "cbClusterAvailabilitySetName": "cbClusterAvailabilitySet",
        "vmStorageAccountContainerName": "vhd",
        "vmSourceImageName": "b39f27a8b8c64d52b05eac6a62ebad85__Ubuntu-14_04_2_LTS-amd64-server-20150309-en-us-30GB",
        "vnetID": "[resourceId('Microsoft.Network/virtualNetworks',parameters('virtualNetworkName'))]",
        "sourceImageName": "[concat('/',subscription().subscriptionId,'/services/images/',variables('vmSourceImageName'))]",
        "dataDiskSize": "1023",
        "networkSettings": {
            "virtualNetworkName": "[parameters('virtualNetworkName')]",
            "addressPrefix": "10.0.0.0/16",
            "subnet": {
                "couchbaseSubnet": {
                    "name": "couchSubnet",
                    "prefix": "10.0.0.0/24",
                    "vnet": "[parameters('virtualNetworkName')]"
                }
            }
        },
        "tshirtSizeS": {
            "numberOfInstances": 3,
            "vmSize": "Standard_A2",
            "dataDisksCount": 4
        },
        "tshirtSizeM": {
            "numberOfInstances": 4,
            "vmSize": "Standard_A6",
            "dataDisksCount": 8
        },
        "tshirtSizeL": {
            "numberOfInstances": 5,
            "vmSize": "Standard_D14",
            "dataDisksCount": 32
        },
        "numberOfInstances": "[variables(concat('tshirtSize', parameters('tshirtSize'))).numberOfInstances]",
        "vmSize": "[variables(concat('tshirtSize', parameters('tshirtSize'))).vmSize]",
        "jumpboxTemplateName": "jumpbox-resources-",
        "baseUrl": "[concat('https://raw.githubusercontent.com/', parameters('gituser'), '/', parameters('gitrepo'), '/master/', parameters('gitrepodir'), '/')]"
    },
    "resources": [{
        "name": "shared-resources",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "properties": {
            "mode": "Incremental",
            "templateLink": {
                "uri": "[concat(variables('baseUrl'), 'shared-resources.json')]",
                "contentVersion": "1.0.0.0"
            },
            "parameters": {
                "targetRegion": {
                    "value": "[parameters('targetRegion')]"
                },
                "networkSettings": {
                    "value": "[variables('networkSettings')]"
                },
                "cbClusterAvailabilitySetName": {
                    "value": "[variables('cbClusterAvailabilitySetName')]"
                },
                "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                }
            }
        }
    }, {
        "name": "jumpbox-resources",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "dependsOn": [
            "[concat('Microsoft.Resources/deployments/', 'shared-resources')]"
        ],
        "properties": {
            "mode": "Incremental",
            "templateLink": {
                "uri": "[concat(variables('baseUrl'), variables('jumpboxTemplateName'), parameters('jumpbox'), '.json')]",
                "contentVersion": "1.0.0.0"
            },
            "parameters": {
                "targetRegion": {
                    "value": "[parameters('targetRegion')]"
                },
                "virtualNetworkName": {
                    "value": "[parameters('virtualNetworkName')]"
                },
                "subnetName": {
                    "value": "[variables('networkSettings').subnet.couchbaseSubnet.name]"
                },
                "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                },
                "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                },
                "adminPassword": {
                    "value": "[parameters('adminPassword')]"
                },
                "computerNamePrefix": {
                    "value": "[parameters('vmNamePrefix')]"
                }
            }
        }
    }]
}