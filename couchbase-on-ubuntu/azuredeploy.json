{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adminUsername": {
            "type": "string",
            "metadata": {
                "Description": "Admin username used when provisioning virtual machines"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "Description": "Admin password used when provisioning virtual machines"
            }
        },
        "storageAccountNamePrefix": {
            "type": "string",
            "defaultValue": "cbdeploy",
            "metadata": {
                "Description": "Storage account name"
            }
        },
        "targetRegion": {
            "type": "string",
            "defaultValue": "West US",
            "metadata": {
                "Description": "Location where resources will be provisioned"
            }
        },
        "virtualNetworkName": {
            "type": "string",
            "defaultValue": "couchVnet",
            "metadata": {
                "Description": "Virtual Network"
            }
        },
        "cbClusterName": {
            "type": "string",
            "defaultValue": "couchbasecluster",
            "metadata": {
                "Description": "The name of the Couchbase cluster"
            }
        },
        "tshirtSize": {
            "type": "string",
            "defaultValue": "S",
            "allowedValues": [
                "S",
                "M",
                "L"
            ],
            "metadata": {
                "Description": "T-shirt size of the Couchbase cluster"
            }
        },
        "dnsNameforLBIP": {
            "type": "string",
            "defaultValue": "fs180cbsample",
            "metadata": {
                "Description": "Load balancer subdomain name: for example (<subdomain>.westus.cloudapp.azure.com)"
            }
        },
        "vmNamePrefix": {
            "type": "string",
            "defaultValue": "cbnode",
            "metadata": {
                "Description": "Prefx for VM names on the cluster"
            }
        },
        "cbPackageDownloadBase": {
            "type": "string",
            "defaultValue": "http://packages.couchbase.com/releases/3.0.3/",
            "metadata": {
                "Description": "Couchbase package download location"
            }
        },
        "cbPackage": {
            "type": "string",
            "defaultValue": "couchbase-server-enterprise_3.0.3-ubuntu12.04_amd64.deb",
            "metadata": {
                "Description": "Couchbase package to install"
            }
        },
        "jumpbox": {
            "type": "string",
            "defaultValue": "enabled",
            "allowedValues": [
                "enabled",
                "disabled"
            ],
            "metadata": {
                "Description": "The flag allowing to enable or disable provisioning of the jumpbox VM that can be used to access the nodes"
            }
        }
    },
    "variables": {
        "cbClusterAvailabilitySetName": "cbClusterAvailabilitySet",
        "vmStorageAccountContainerName": "vhd",
        "vmSourceImageName": "b39f27a8b8c64d52b05eac6a62ebad85__Ubuntu-12_04_5_LTS-amd64-server-20150413-en-us-30GB",
        "vnetID": "[resourceId('Microsoft.Network/virtualNetworks',parameters('virtualNetworkName'))]",
        "sourceImage": "[concat('/',subscription().subscriptionId,'/services/images/',variables('vmSourceImageName'))]",
        "gituser": "fullscale180",
        "gitrepo": "arm",
        "gitrepodir": "couchbase-on-ubuntu",
        "dataDiskSize": "1023",
        "networkSettings": {
            "virtualNetworkName": "[parameters('virtualNetworkName')]",
            "addressPrefix": "10.0.0.0/16",
            "subnet": {
                "couchbaseSubnet": {
                    "name": "couchSubnet",
                    "prefix": "10.0.0.0/20",
                    "vnet": "[parameters('virtualNetworkName')]"
                }
            }
        },
        "groupIpPrefix": "10.0.",
        "jumpboxTemplateName": "jumpbox-resources-",
        "baseUrl": "[concat('https://raw.githubusercontent.com/', variables('gituser'), '/', variables('gitrepo'), '/master/', variables('gitrepodir'), '/')]",
        "storageAccountGroupS": {
            "storageAccountCount": 1,
            "vmsPerStorageAccount": 3,
            "vmSize": "Standard_A2",
            "usingStaticIpSettingsComment": "and IP addresses follow a convention",
            "vmIpAddresses": "10.0.0.10 10.0.0.11 10.0.0.12",
            "maxNumberOfDataDisksForVmSizeNotUsedButHereForReference": 4,
            "backendIPConfigurations": [{
                "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(parameters('storageAccountNamePrefix'), '0nic0')),'/ipConfigurations/ipconfig1')]"
            }, {
                "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(parameters('storageAccountNamePrefix'), '0nic1')),'/ipConfigurations/ipconfig1')]"
            }, {
                "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(parameters('storageAccountNamePrefix'), '0nic2')),'/ipConfigurations/ipconfig1')]"
            }]
        },
        "storageAccountGroupM": {
            "storageAccountCount": 1,
            "vmsPerStorageAccount": 4,
            "vmSize": "Standard_A6",
            "usingStaticIpSettingsComment": "and IP addresses follow a convention",
            "vmIpAddresses": "10.0.0.10 10.0.0.11 10.0.0.12 10.0.0.13",
            "maxNumberOfDataDisksForVmSizeNotUsedButHereForReference": 8,
            "backendIPConfigurations": [{
                "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(parameters('storageAccountNamePrefix'), '0nic0')),'/ipConfigurations/ipconfig1')]"
            }, {
                "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(parameters('storageAccountNamePrefix'), '0nic1')),'/ipConfigurations/ipconfig1')]"
            }, {
                "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(parameters('storageAccountNamePrefix'), '0nic2')),'/ipConfigurations/ipconfig1')]"
            }, {
                "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(parameters('storageAccountNamePrefix'), '0nic3')),'/ipConfigurations/ipconfig1')]"
            }]
        },
        "storageAccountGroupL": {
            "storageAccountCount": 5,
            "vmsPerStorageAccount": 1,
            "vmSize": "Standard_D14",
            "usingStaticIpSettingsComment": "and IP addresses follow a convention",
            "vmIpAddresses": "10.0.0.10 10.0.1.10 10.0.2.10 10.0.3.10 10.0.4.10",
            "maxNumberOfDataDisksForVmSizeNotUsedButHereForReference": 32,
            "backendIPConfigurations": [{
                "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(parameters('storageAccountNamePrefix'), '0nic0')),'/ipConfigurations/ipconfig1')]"
            }, {
                "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(parameters('storageAccountNamePrefix'), '0nic1')),'/ipConfigurations/ipconfig1')]"
            }, {
                "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(parameters('storageAccountNamePrefix'), '0nic2')),'/ipConfigurations/ipconfig1')]"
            }, {
                "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(parameters('storageAccountNamePrefix'), '0nic3')),'/ipConfigurations/ipconfig1')]"
            }, {
                "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(parameters('storageAccountNamePrefix'), '0nic4')),'/ipConfigurations/ipconfig1')]"
            }]
        },
        "storageAccountGroup": "[variables(concat('storageAccountGroup', parameters('tshirtSize')))]",
        "internalIp": "10.0.0.100"
    },
    "resources": [{
        "name": "shared-resources",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "properties": {
            "mode": "Incremental",
            "templateLink": {
                "uri": "[concat(variables('baseUrl'), 'shared-resources.json')]",
                "contentVersion": "1.0.0.0"
            },
            "parameters": {
                "targetRegion": {
                    "value": "[parameters('targetRegion')]"
                },
                "networkSettings": {
                    "value": "[variables('networkSettings')]"
                },
                "cbClusterAvailabilitySetName": {
                    "value": "[variables('cbClusterAvailabilitySetName')]"
                },
                "storageAccountNamePrefix": {
                    "value": "[parameters('storageAccountNamePrefix')]"
                }
            }
        }
    }, {
        "name": "jumpbox-resources",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "dependsOn": ["storageAccountGroupLoop"],
        "properties": {
            "mode": "Incremental",
            "templateLink": {
                "uri": "[concat(variables('baseUrl'), variables('jumpboxTemplateName'), parameters('jumpbox'), '.json')]",
                "contentVersion": "1.0.0.0"
            },
            "parameters": {
                "targetRegion": {
                    "value": "[parameters('targetRegion')]"
                },
                "virtualNetworkName": {
                    "value": "[parameters('virtualNetworkName')]"
                },
                "subnetName": {
                    "value": "[variables('networkSettings').subnet.couchbaseSubnet.name]"
                },
                "storageAccountNamePrefix": {
                    "value": "[parameters('storageAccountNamePrefix')]"
                },
                "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                },
                "adminPassword": {
                    "value": "[parameters('adminPassword')]"
                },
                "computerNamePrefix": {
                    "value": "[parameters('vmNamePrefix')]"
                }
            }
        }
    }, {
        "name": "[concat('storage-account-group',copyindex())]",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "dependsOn": [
            "[concat('Microsoft.Resources/deployments/', 'shared-resources')]"
        ],
        "copy": {
            "name": "storageAccountGroupLoop",
            "count": "[variables('storageAccountGroup').storageAccountCount]"
        },
        "properties": {
            "mode": "Incremental",
            "templateLink": {
                "uri": "[concat(variables('baseUrl'), 'storage-account-group.json')]",
                "contentVersion": "1.0.0.0"
            },
            "parameters": {
                "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                },
                "adminPassword": {
                    "value": "[parameters('adminPassword')]"
                },
                "targetRegion": {
                    "value": "[parameters('targetRegion')]"
                },
                "tshirtSize": {
                    "value": "[parameters('tshirtSize')]"
                },
                "subnet": {
                    "value": "[variables('networkSettings').subnet.couchbaseSubnet]"
                },
                "availabilitySet": {
                    "value": "[variables('cbClusterAvailabilitySetName')]"
                },
                "storageAccountName": {
                    "value": "[concat(parameters('storageAccountNamePrefix'), copyindex())]"
                },
                "sourceImage": {
                    "value": "[variables('sourceImage')]"
                },
                "nodeCountPerStorageAccount": {
                    "value": "[variables('storageAccountGroup').vmsPerStorageAccount]"
                },
                "baseUrl": {
                    "value": "[variables('baseUrl')]"
                },
                "cbClusterName": {
                    "value": "[parameters('cbClusterName')]"
                },
                 "nodesIpPrefix": {
                    "value": "[concat(variables('groupIpPrefix'), copyindex(), '.1')]"
                },
                 "vmIpAddresses": {
                    "value": "[variables('storageAccountGroup').vmIpAddresses]"
                },
                "vmSize": {
                    "value": "[variables('storageAccountGroup').vmSize]"
                },
                "cbPackageDownloadBase": {
                    "value": "[parameters('cbPackageDownloadBase')]"
                },
                "cbPackage": {
                    "value": "[parameters('cbPackage')]"
                }
            }
        }
    }, {
        "name": "loadBalancerConfiguration",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "dependsOn": ["storageAccountGroupLoop"],
        "properties": {
            "mode": "Incremental",
            "templateLink": {
                "uri": "[concat(variables('baseUrl'), 'load-balancer.json')]",
                "contentVersion": "1.0.0.0"
            },
            "parameters": {
                "targetRegion": {
                    "value": "[parameters('targetRegion')]"
                },
                "subnet": {
                    "value": "[variables('networkSettings').subnet.couchbaseSubnet]"
                },
                "internalIp": {
                    "value": "[variables('internalIp')]"
                },
                "storageAccountGroup": {
                    "value": "[variables('storageAccountGroup')]"
                }
            }
        }
    }]
}