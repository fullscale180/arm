{
  "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "adminUsername": {
      "type": "string",
      "metadata": {
        "Description": "Admin username used when provisioning virtual machines"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "Description": "Admin password used when provisioning virtual machines"
      }
    },
    "targetRegion": {
      "type": "string",
      "metadata": {
        "Description": "Location where resources will be provisioned"
      }
    },
    "tshirtSize": {
      "type": "string",
      "metadata": {
        "Description": "Tshirt size abstraction for cluster size"
      }
    },
    "subnet": {
      "type": "object",
      "metadata": {
        "Description": "The name of the subnet to deploy resources into"
      }
    },
    "availabilitySet": {
      "type": "string",
      "metadata": {
        "Description": "The availabilty set to use for the data nodes"
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "Description": "Storage account name for the group"
      }
    },
    "sourceImage": {
      "type": "string",
      "metadata": {
        "Description": "Source image for the VM"
      }
    },
    "nodeCountPerStorageAccount": {
      "type": "int",
      "metadata": {
        "Description": "Number of cluster nodes per storage account. One storage account cannot support more than 40 disks."
      }
    },
    "baseUrl": {
      "type": "string",
      "metadata": {
        "Description": "Base URL of the templates and scripts."
      }
    },
    "cbClusterName": {
      "type": "string",
      "metadata": {
        "Description": "Name for couchbase cluster."
      }
    },
    "nodesIpPrefix": {
      "type": "string",
      "metadata": {
        "Description": "Prefix for the IPs of the nodes in this group"
      },
    },
    "vmIpAddresses": {
      "type": "string",
      "metadata": {
        "Description": "Templates are using static IP addresses for VMs. This is a list of all IPs by convention."
      },
    },
    "vmSize": {
      "type": "string",
      "metadata": {
        "Description": "Size of the VM"
      },
    },
    "cbPackageDownloadBase": {
      "type": "string",
      "metadata": {
        "Description": "Couchbase package download location"
      }
    },
    "cbPackage": {
      "type": "string",
      "metadata": {
        "Description": "Couchbase package to install"
      }
    }
  },
  "variables": {
    "clusterTemplateS": "[concat(parameters('baseUrl'), 'cluster-nodes-A2.json')]",
    "clusterTemplateM": "[concat(parameters('baseUrl'), 'cluster-nodes-A6.json')]",
    "clusterTemplateL": "[concat(parameters('baseUrl'), 'cluster-nodes-D14.json')]",
    "clusterTemplate": "[variables(concat('clusterTemplate', parameters('tshirtSize')))]",
    "cbPackageDownloadLink": "[concat(parameters('cbPackageDownloadBase'), parameters('cbPackage'))]",
    "vmScripts": {
      "scriptsToDownload": [
        "[concat(parameters('baseUrl'), 'couchbase-azure-install.sh')]",
        "[variables('cbPackageDownloadLink')]",
        "https://raw.githubusercontent.com/azurermtemplates/azurermtemplates/master/shared_scripts/ubuntu/vm-disk-utils-0.1.sh"
      ],
      "commandToExecute": "[concat('bash couchbase-azure-install.sh -n ', parameters('cbClusterName'), ' -p ', parameters('cbPackage'), ' -i ', parameters('vmIpAddresses'))]"
    }
  },
  "resources": [{
    "type": "Microsoft.Storage/storageAccounts",
    "name": "[parameters('storageAccountName')]",
    "apiVersion": "2014-12-01-preview",
    "location": "[parameters('targetRegion')]",
    "properties": {
      "accountType": "Standard_LRS"
    }
  }, {
    "name": "cluster-node",
    "type": "Microsoft.Resources/deployments",
    "apiVersion": "2015-01-01",
    "dependsOn": [
      "[concat('Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]"
    ],
    "properties": {
      "mode": "Incremental",
      "templateLink": {
        "uri": "[variables('clusterTemplate')]",
        "contentVersion": "1.0.0.0"
      },
      "parameters": {
        "adminUsername": {
          "value": "[parameters('adminUsername')]"
        },
        "adminPassword": {
          "value": "[parameters('adminPassword')]"
        },
        "targetRegion": {
          "value": "[parameters('targetRegion')]"
        },
        "tshirtSize": {
          "value": "[parameters('tshirtSize')]"
        },
        "subnet": {
          "value": "[parameters('subnet')]"
        },
        "availabilitySet": {
          "value": "[parameters('availabilitySet')]"
        },
        "storageAccountName": {
          "value": "[parameters('storageAccountName')]"
        },
        "sourceImage": {
          "value": "[parameters('sourceImage')]"
        },
        "nodeCountPerStorageAccount": {
          "value": "[parameters('nodeCountPerStorageAccount')]"
        },
        "baseUrl": {
          "value": "[parameters('baseUrl')]"
        },
        "cbClusterName": {
          "value": "[parameters('cbClusterName')]"
        },
        "nodesIpPrefix": {
          "value": "[parameters('nodesIpPrefix')]"
        },
        "vmSize": {
          "value": "[parameters('vmSize')]"
        },
        "cbPackageDownloadBase": {
          "value": "[parameters('cbPackageDownloadBase')]"
        },
        "cbPackage": {
          "value": "[parameters('cbPackage')]"
        },
        "vmScripts": {
          "value": "[variables('vmScripts')]"
        }
      }
    }
  }]
}